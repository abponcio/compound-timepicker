<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="compound-timepicker.html">
<link rel="import" href="compound-timepicker-dialog-theme.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="../paper-dialog-behavior/paper-dialog-behavior.html">

<!--
Wrapper for <compound-timepicker>.

Example:

    <compound-timepicker-dialog></compound-timepicker-dialog>

@element compound-timepicker-dialog
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="compound-timepicker-dialog">

  <template>
    <style include="compound-timepicker-dialog-theme"></style>

    <!-- Main codes starts here -->
    <div class="container layout vertical flex-auto">
      <!-- compound-timepicker's code -->
      <compound-timepicker id="timepicker"
                           class="flex-auto layout vertical content"
                           hours="{{hours}}"
                           minutes="{{minutes}}"
                           step="{{step}}"
                           time-format="{{timeFormat}}"
                           time="{{time}}"></compound-timepicker>

      <!-- Dialog buttons -->
      <div class="buttons layout horizontal">
        <paper-button dialog-dismiss on-tap="_revertChange">Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="_updateRevert">OK</paper-button>
      </div>
    </div>

  </template>

</dom-module>

<script>

  Polymer({

    is: 'compound-timepicker-dialog',

    properties: {
      /**
       * Set the starting hours of the clock.
       */
      hours: Number,

      /**
       * Set the starting minutes of the clock.
       */
      minutes: Number,

      /**
       * Set the starting clock step.
       */
      step: Number,

      /**
       * Returns the seleced time from either the user's input or
       * from first init of the component.
       */
      time: {
        type: String,
        notify: true
      },

      /**
       * 12/ 24 hours time format.
       */
      timeFormat: Number,

      // stores time before opening the dialog.
      _revert: {
        type: Object,
        value: function() {
          return {};
        }
      },
    },

    behaviors: [
      Polymer.PaperDialogBehavior,
      Polymer.NeonAnimationRunnerBehavior
    ],

    listeners: {
      'neon-animation-finish': '_onNeonAnimationFinish'
    },

    _renderOpened: function() {
      if (this.withBackdrop) {
        this.backdropElement.open();
      }
      this.playAnimation('entry');
    },

    _renderClosed: function() {
      if (this.withBackdrop) {
        this.backdropElement.close();
      }
      this.playAnimation('exit');
    },

    _onNeonAnimationFinish: function() {
      if (this.opened) {
        this._finishRenderOpened();
      } else {
        this._finishRenderClosed();
      }
    },

    // store selected time on attached.
    attached: function() {
      this._revert = this._storeTime(this.$.timepicker.hours,
                                     this.$.timepicker.minutes,
                                     this.$.timepicker.timeFormat,
                                     this.$.timepicker.time);
    },

    /**
     * Force update the selected time from the compound-timepicker.
     */
    notifyTimeUpdate: function () {
      this.$.timepicker.notifyTimeUpdate();
    },

    // store selected Time before dialog opened.
    _storeTime: function(_h, _m, _f, _t) {
      var _r = {};

      if (_f === 12) {
        if (_t.slice(-2, -1) === 'P') {
          _h = (_h + 12) % 24;
        }
      }else {
        _h = parseInt(_t.slice(0, 2));
      }

      _r.hours = _h;
      _r.minutes = _m;
      _r.timeFormat = _f;
      _r.time = _t;

      return _r;
    },

    // revert selected time.
    _revertChange: function () {
      this.$.timepicker.hours = 'a';
      this.$.timepicker.timeFormat = this._revert.timeFormat;
      this.$.timepicker.hours = this._revert.hours;
      this.$.timepicker.minutes = this._revert.minutes;
      this.$.timepicker.notifyTimeUpdate();
    },

    // update revert time.
    _updateRevert: function () {
      this._revert = this._storeTime(this.$.timepicker.hours,
                                     this.$.timepicker.minutes,
                                     this.$.timepicker.timeFormat,
                                     this.$.timepicker.time);
    }
  });

</script>
